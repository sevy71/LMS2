{% extends "base.html" %}

{% block title %}Admin Dashboard - Last Man Standing{% endblock %}

{% block content %}
<!-- Header with mobile-responsive buttons -->
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center flex-column flex-md-row">
        <h1 class="mb-2 mb-md-0">Admin Dashboard</h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                <i class="fas fa-key"></i> <span class="d-none d-md-inline">Change Password</span>
            </button>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-sign-out-alt"></i> <span class="d-none d-md-inline">Logout</span>
            </a>
        </div>
    </div>
</div>

<!-- HERO SECTION - Most Important Info -->
<div class="row mb-5">
    <div class="col-lg-8 mb-4 mb-lg-0">
        <div class="card border-primary shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-play-circle me-2"></i>Current Round Status
                </h4>
            </div>
            <div class="card-body p-4">
                {% if current_round %}
                    <div class="d-flex justify-content-between align-items-start mb-3 flex-column flex-md-row">
                        <div class="mb-2 mb-md-0">
                            <h2 class="text-primary mb-2">Round {{ current_round.round_number }}</h2>
                            <p class="text-muted mb-0">Premier League Matchday {{ current_round.pl_matchday }}</p>
                        </div>
                        <span class="badge {% if current_round.status == 'active' %}bg-success{% elif current_round.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %} fs-6 px-3 py-2">
                            {{ current_round.status.title() }}
                        </span>
                    </div>
                    
                    {% if current_round.start_date or current_round.end_date %}
                        <div class="row text-center">
                            {% if current_round.start_date %}
                                <div class="col-6">
                                    <i class="fas fa-calendar-plus text-success"></i>
                                    <strong class="d-block">Start</strong>
                                    <small class="text-muted">{{ current_round.start_date.strftime('%d %b %Y, %H:%M') }}</small>
                                </div>
                            {% endif %}
                            {% if current_round.end_date %}
                                <div class="col-6">
                                    <i class="fas fa-calendar-times text-danger"></i>
                                    <strong class="d-block">Deadline</strong>
                                    <small class="text-muted">{{ current_round.end_date.strftime('%d %b %Y, %H:%M') }}</small>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                        <h4 class="text-muted">No Active Round</h4>
                        <p class="mb-3">Create a new round to get started</p>
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createRoundModal">
                            <i class="fas fa-plus me-2"></i>Create New Round
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Competition Stats</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-12 mb-3">
                        <h3 class="text-primary mb-0">{{ players|length }}</h3>
                        <small class="text-muted">Total Players</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success mb-0">{{ players|selectattr('status', 'equalto', 'active')|list|length }}</h4>
                        <small class="text-muted">Active</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-danger mb-0">{{ players|selectattr('status', 'equalto', 'eliminated')|list|length }}</h4>
                        <small class="text-muted">Eliminated</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PRIMARY ACTIONS - Most Used -->
<div class="row mb-4">
    <div class="col-12">
        <h3 class="mb-3">
            <i class="fas fa-tasks me-2"></i>Primary Actions
            <small class="text-muted d-none d-md-inline">- Daily Operations</small>
        </h3>
    </div>
</div>

<div class="row mb-5">
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card border-warning shadow-sm h-100">
            <div class="card-body text-center p-4">
                <i class="fas fa-paper-plane text-warning fa-2x mb-3"></i>
                <h5 class="card-title">Send Pick Links</h5>
                <p class="card-text text-muted small">Send WhatsApp links to all active players for current round</p>
                <a href="{{ url_for('send_picks') }}" class="btn btn-warning btn-lg w-100">
                    <i class="fas fa-paper-plane me-2"></i>Send Links
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card border-info shadow-sm h-100">
            <div class="card-body text-center p-4">
                <i class="fas fa-trophy text-info fa-2x mb-3"></i>
                <h5 class="card-title">Process Results</h5>
                <p class="card-text text-muted small">Enter match results and eliminate players whose teams lost</p>
                <button class="btn btn-info btn-lg w-100" data-bs-toggle="modal" data-bs-target="#resultsModal">
                    <i class="fas fa-calculator me-2"></i>Process Results
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card border-success shadow-sm h-100">
            <div class="card-body text-center p-4">
                <i class="fas fa-plus text-success fa-2x mb-3"></i>
                <h5 class="card-title">Create New Round</h5>
                <p class="card-text text-muted small">Set up the next round with PL fixtures and dates</p>
                <button class="btn btn-success btn-lg w-100" data-bs-toggle="modal" data-bs-target="#createRoundModal">
                    <i class="fas fa-plus me-2"></i>New Round
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card border-danger shadow-sm h-100">
            <div class="card-body text-center p-4">
                <i class="fas fa-bell text-danger fa-2x mb-3"></i>
                <h5 class="card-title">Reminders</h5>
                <p class="card-text text-muted small">Manage automatic pick reminders (4hr & 1hr before deadline)</p>
                <a href="{{ url_for('reminders_dashboard') }}" class="btn btn-danger btn-lg w-100">
                    <i class="fas fa-bell me-2"></i>Manage Reminders
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card border-warning shadow-sm h-100">
            <div class="card-body text-center p-4">
                <i class="fas fa-cog text-warning fa-2x mb-3"></i>
                <h5 class="card-title">Manage Rounds</h5>
                <p class="card-text text-muted small">View, activate, or delete existing rounds</p>
                <button class="btn btn-warning btn-lg w-100" data-bs-toggle="modal" data-bs-target="#manageRoundsModal">
                    <i class="fas fa-cog me-2"></i>Manage Rounds
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SECONDARY ACTIONS - Regular Use -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">
            <i class="fas fa-cogs me-2"></i>Management Tools
            <small class="text-muted d-none d-md-inline">- Regular Operations</small>
        </h4>
    </div>
</div>

<div class="row mb-5">
    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <button class="btn btn-outline-primary w-100 py-3" data-bs-toggle="modal" data-bs-target="#addFixturesModal">
            <i class="fas fa-futbol d-block mb-2"></i>
            <span>Add Fixtures</span>
        </button>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <a href="{{ url_for('picks_grid') }}" class="btn btn-outline-info w-100 py-3">
            <i class="fas fa-th d-block mb-2"></i>
            <span>Picks Grid</span>
        </a>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <button class="btn btn-outline-success w-100 py-3" data-bs-toggle="modal" data-bs-target="#statsModal">
            <i class="fas fa-chart-bar d-block mb-2"></i>
            <span>Statistics</span>
        </button>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
        <button class="btn btn-outline-info w-100 py-3" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fas fa-download d-block mb-2"></i>
            <span>Export Data</span>
        </button>
    </div>
</div>

<!-- UTILITY ACTIONS - Occasional Use -->
<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#utilityActions">
            <h5 class="mb-0">
                <i class="fas fa-tools me-2"></i>Utility Actions
                <small class="text-muted d-none d-md-inline">- Occasional Use</small>
                <i class="fas fa-chevron-down ms-2"></i>
            </h5>
        </button>
    </div>
</div>

<div class="collapse" id="utilityActions">
    <div class="row mb-5">
        <div class="col-lg-4 col-md-6 mb-3">
            <button class="btn btn-outline-success w-100 py-2" id="generateGeneralLinkBtn">
                <i class="fas fa-link me-2"></i>General Registration Link
            </button>
        </div>
        <div class="col-lg-4 col-md-6 mb-3">
            <button class="btn btn-outline-danger w-100 py-2" data-bs-toggle="modal" data-bs-target="#resetGameModal">
                <i class="fas fa-trash me-2"></i>Reset Game
            </button>
        </div>
    </div>
</div>

<!-- PLAYERS SECTION - Collapsible -->
<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-link p-0 text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#playersSection">
            <h4 class="mb-0">
                <i class="fas fa-users me-2"></i>Player Management
                <span class="badge bg-secondary ms-2">{{ players|length }} players</span>
                <i class="fas fa-chevron-down ms-auto float-end"></i>
            </h4>
        </button>
    </div>
</div>

<div class="collapse show" id="playersSection">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-column flex-md-row">
                    <h5 class="card-title mb-2 mb-md-0">Players</h5>
                    <div class="dropdown">
                        <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-plus me-1"></i>Add Player
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addPlayerModal">Add Single Player</a></li>
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkPlayerModal">Bulk Import Players</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    {% if players %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th class="d-none d-md-table-cell">ID</th>
                                        <th>
                                            <button type="button" class="btn btn-link p-0 text-dark fw-bold" id="sortNameBtn" onclick="sortPlayersByName()">
                                                Name <span id="nameSortIcon">↕️</span>
                                            </button>
                                        </th>
                                        <th class="d-none d-lg-table-cell">WhatsApp Number</th>
                                        <th>Status</th>
                                        <th class="d-none d-md-table-cell">Unreachable</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in players %}
                                        <tr>
                                            <td class="d-none d-md-table-cell">{{ player.id }}</td>
                                            <td>
                                                <strong>{{ player.name }}</strong>
                                                <div class="d-lg-none small text-muted">
                                                    {% if player.whatsapp_number %}{{ player.whatsapp_number }}{% else %}No WhatsApp{% endif %}
                                                </div>
                                            </td>
                                            <td class="d-none d-lg-table-cell">{{ player.whatsapp_number or '-' }}</td>
                                            <td>
                                                <span class="badge 
                                                    {% if player.status == 'active' %}bg-success
                                                    {% elif player.status == 'eliminated' %}bg-danger
                                                    {% else %}bg-warning{% endif %}">
                                                    {{ player.status.title() }}
                                                </span>
                                                <div class="d-md-none small">
                                                    {% if player.unreachable %}
                                                        <span class="badge bg-warning mt-1">Unreachable</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td class="d-none d-md-table-cell">
                                                {% if player.unreachable %}
                                                    <span class="badge bg-warning">Yes</span>
                                                {% else %}
                                                    <span class="badge bg-success">No</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                        <i class="fas fa-cog"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><button class="dropdown-item edit-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}" data-player-whatsapp="{{ player.whatsapp_number }}">
                                                            <i class="fas fa-edit me-2"></i>Edit
                                                        </button></li>
                                                        {% if player.whatsapp_number %}
                                                            <li><button class="dropdown-item registration-link-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}" title="Generate registration link for family members">
                                                                <i class="fas fa-share me-2"></i>Share Link
                                                            </button></li>
                                                        {% endif %}
                                                        <li><hr class="dropdown-divider"></li>
                                                        {% if player.status == 'active' %}
                                                            <li><button class="dropdown-item text-warning eliminate-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">
                                                                <i class="fas fa-times me-2"></i>Eliminate
                                                            </button></li>
                                                        {% else %}
                                                            <li><button class="dropdown-item text-success reactivate-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">
                                                                <i class="fas fa-undo me-2"></i>Reactivate
                                                            </button></li>
                                                        {% endif %}
                                                        <li><button class="dropdown-item text-danger delete-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">
                                                            <i class="fas fa-trash me-2"></i>Delete
                                                        </button></li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-users text-muted fa-3x mb-3"></i>
                            <p class="text-muted">No players registered yet.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                                <i class="fas fa-plus me-2"></i>Add First Player
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All existing modals from original file... -->
<!-- Add Single Player Modal -->
<div class="modal fade" id="addPlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Single Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPlayerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="playerName" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="playerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="playerWhatsapp" class="form-label">WhatsApp Number</label>
                        <input type="tel" class="form-control" id="playerWhatsapp" placeholder="+44XXXXXXXXXX">
                        <div class="form-text">Include country code (e.g., +44 for UK). Leave blank if not available.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Import Players Modal -->
<div class="modal fade" id="bulkPlayerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Import Players</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bulkPlayerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bulkPlayerData" class="form-label">Player Data</label>
                        <textarea class="form-control" id="bulkPlayerData" rows="10" placeholder="John Smith&#10;Jane Doe, +447987654321&#10;Mike Johnson&#10;Sarah Wilson, +447555123456" required></textarea>
                        <div class="form-text">
                            Enter one player per line. Format options:<br>
                            • Name only: <strong>John Smith</strong><br>
                            • Name with WhatsApp: <strong>Jane Doe, +447987654321</strong>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Flexible Format:</strong> You can enter just names, or names with WhatsApp numbers. If no number is provided, it can be added later.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Players</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Player Modal -->
<div class="modal fade" id="editPlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editPlayerForm">
                <input type="hidden" id="editPlayerId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editPlayerName" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="editPlayerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPlayerWhatsapp" class="form-label">WhatsApp Number</label>
                        <input type="tel" class="form-control" id="editPlayerWhatsapp" placeholder="+44XXXXXXXXXX">
                        <div class="form-text">Include country code (e.g., +44 for UK) or leave empty</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- General Registration Link Modal -->
<div class="modal fade" id="generalRegistrationLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">General Registration Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Share this link with anyone!</strong><br>
                    This general registration link allows anyone to join the Last Man Standing competition.
                </div>
                
                <div class="mb-3">
                    <label for="generalRegistrationUrl" class="form-label">General Registration Link</label>
                    <div class="input-group">
                        <input type="url" class="form-control" id="generalRegistrationUrl" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyGeneralLinkBtn" title="Copy to clipboard">
                            📋 Copy
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-success d-none" id="copyGeneralSuccess">
                    Link copied to clipboard! 📋
                </div>
                
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">📱 How to share:</h6>
                        <ul class="mb-0 small">
                            <li>Copy the link and share via WhatsApp, text, email, or social media</li>
                            <li>Anyone can register with their own details</li>
                            <li>New players can optionally provide their WhatsApp number</li>
                            <li>Perfect for inviting friends, colleagues, or posting in groups</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Registration Link Modal -->
<div class="modal fade" id="registrationLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Registration Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="linkPlayerId">
                <div class="alert alert-info">
                    <strong id="linkPlayerName"></strong> can share this link with family members who want to join using the same WhatsApp number.
                </div>
                
                <div class="mb-3">
                    <label for="registrationUrl" class="form-label">Registration Link</label>
                    <div class="input-group">
                        <input type="url" class="form-control" id="registrationUrl" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn" title="Copy to clipboard">
                            📋 Copy
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-success d-none" id="copySuccess">
                    Link copied to clipboard! 📋
                </div>
                
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">📱 How to share:</h6>
                        <ul class="mb-0 small">
                            <li>Copy the link and send it via WhatsApp, text, or email</li>
                            <li>Family members will be registered with the same WhatsApp number</li>
                            <li>They'll receive pick reminders on the shared WhatsApp</li>
                            <li>Each person still competes individually</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deletePlayerId">
                <p>Are you sure you want to delete player <strong id="deletePlayerName"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Player</button>
            </div>
        </div>
    </div>
</div>

<!-- Create New Round Modal -->
<div class="modal fade" id="createRoundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Round</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createRoundForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roundNumber" class="form-label">Game Round Number</label>
                        <input type="number" class="form-control" id="roundNumber" min="1" required>
                        <div class="form-text">Enter the game round number (e.g., 1, 2, 3...)</div>
                    </div>
                    <div class="mb-3">
                        <label for="plMatchday" class="form-label">Premier League Matchday</label>
                        <select class="form-control" id="plMatchday" required>
                            <option value="">Loading matchdays...</option>
                        </select>
                        <div class="form-text">Select which PL matchday to use for fixtures</div>
                        <div id="matchdayInfo" class="mt-2 text-muted"></div>
                    </div>
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date & Time</label>
                        <input type="datetime-local" class="form-control" id="startDate">
                        <div class="form-text">When players can start making picks (optional)</div>
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date & Time</label>
                        <input type="datetime-local" class="form-control" id="endDate">
                        <div class="form-text">Deadline for picks (optional)</div>
                    </div>
                    <div class="mb-3">
                        <label for="roundStatus" class="form-label">Initial Status</label>
                        <select class="form-control" id="roundStatus" required>
                            <option value="pending">Pending</option>
                            <option value="active">Active</option>
                        </select>
                        <div class="form-text">Set to Active to allow picks immediately</div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> You can add fixtures to this round after creating it using the "Add Fixtures" button.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Round</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Manage Rounds Modal -->
<div class="modal fade" id="manageRoundsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Rounds</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="roundsList">
                    Loading rounds...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Game Modal -->
<div class="modal fade" id="resetGameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Game</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning:</strong> This will permanently delete all game data except players.
                </div>
                <p>This action will delete:</p>
                <ul>
                    <li>All rounds and fixtures</li>
                    <li>All player picks</li>
                    <li>All pending WhatsApp messages</li>
                </ul>
                <p><strong>Players will be preserved</strong> but their status will be reset to "active".</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                
                <div class="mt-3">
                    <label for="confirmResetText" class="form-label">Type "RESET GAME" to confirm:</label>
                    <input type="text" class="form-control" id="confirmResetText" placeholder="RESET GAME">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmResetBtn" disabled>Reset Game</button>
            </div>
        </div>
    </div>
</div>

<!-- Send Pick Links Modal -->
<div class="modal fade" id="sendPickLinksModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Pick Links</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="roundSelect" class="form-label">Select Round</label>
                    <select class="form-control" id="roundSelect" required>
                        <option value="">Loading rounds...</option>
                    </select>
                    <div class="form-text">Pick links will be sent to all active players for this round</div>
                </div>
                
                <div id="roundInfo" class="mt-3"></div>
                
                <div class="alert alert-info">
                    <strong>What will happen:</strong><br>
                    • Unique secure links will be generated for each active player<br>
                    • Links will be queued for WhatsApp delivery<br>
                    • Players can use their link to submit their pick<br>
                    • Each link can only be used once and expires after 7 days
                </div>
                
                <div id="playersPreview" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmSendLinksBtn" disabled>Send Pick Links</button>
            </div>
        </div>
    </div>
</div>

<!-- Player Statistics Modal -->
<div class="modal fade" id="statsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">📊 Player Statistics Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-12">
                        <div id="competitionStats" class="row">
                            <!-- Competition stats will load here -->
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6>Individual Player Statistics</h6>
                        <div id="playerStatsTable">
                            Loading player statistics...
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h6>Pick History</h6>
                        <div id="pickHistoryTable">
                            Loading pick history...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Export/Backup Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">💾 Export & Backup Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Export Options:</strong> Download your competition data in various formats for backup or analysis.
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">👥 Players Data</h6>
                                <p class="card-text">Export all player information including status and contact details</p>
                                <button class="btn btn-primary export-btn" data-export="players">Download Players CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">🏆 Rounds & Fixtures</h6>
                                <p class="card-text">Export all rounds, fixtures, and match results</p>
                                <button class="btn btn-primary export-btn" data-export="rounds">Download Rounds CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">🎯 Player Picks</h6>
                                <p class="card-text">Export all player picks with results</p>
                                <button class="btn btn-primary export-btn" data-export="picks">Download Picks CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">📊 Full Statistics</h6>
                                <p class="card-text">Export comprehensive player statistics</p>
                                <button class="btn btn-primary export-btn" data-export="stats">Download Stats CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 mt-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="card-title">🔄 Complete Backup</h6>
                                <p class="card-text">Export everything in a single comprehensive file</p>
                                <button class="btn btn-success btn-lg export-btn" data-export="full">Download Complete Backup</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Admin Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                        <div class="form-text">Minimum 6 characters</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Process Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Process Match Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="resultsRoundSelect" class="form-label">Select Round</label>
                    <select class="form-control" id="resultsRoundSelect" required>
                        <option value="">Loading rounds...</option>
                    </select>
                    <div class="form-text">Select the round to process results for</div>
                </div>
                
                <div id="resultsRoundInfo" class="mt-3"></div>
                <div id="roundFixtures" class="mt-3"></div>
                <div id="playerPicks" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="processResultsBtn" disabled>Process Results & Eliminate Players</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Fixtures Modal -->
<div class="modal fade" id="addFixturesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Fixtures to Round</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="fixtureRoundSelect" class="form-label">Select Round</label>
                    <select class="form-control" id="fixtureRoundSelect" required>
                        <option value="">Loading rounds...</option>
                    </select>
                    <div class="form-text">Select a round that needs fixtures added</div>
                </div>
                
                <div id="fixtureRoundInfo" class="mt-3"></div>
                
                <div class="alert alert-info">
                    <strong>What will happen:</strong><br>
                    • Fixtures will be fetched from the Premier League API<br>
                    • If API fails, fallback fixtures will be created<br>
                    • This ensures players always have teams to pick from
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddFixturesBtn" disabled>Add Fixtures</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Premier League team abbreviations mapping
function getTeamAbbreviation(teamName) {
    const abbreviations = {
        'Arsenal': 'ARS',
        'Aston Villa': 'AVFC',
        'Aston Villa FC': 'AVFC',
        'AFC Bournemouth': 'BOU',
        'Bournemouth': 'BOU',
        'Bournemouth AFC': 'BOU',
        'Brentford': 'BRE',
        'Brighton': 'BHA',
        'Brighton & Hove Albion': 'BHA',
        'Burnley': 'BUR',
        'Chelsea': 'CHE',
        'Crystal Palace': 'CRY',
        'Everton': 'EVE',
        'Everton FC': 'EVE',
        'Fulham': 'FUL',
        'Liverpool': 'LIV',
        'Liverpool FC': 'LIV',
        'Luton Town': 'LUT',
        'Manchester City': 'MCI',
        'Manchester City FC': 'MCI',
        'Manchester United': 'MUN',
        'Manchester United FC': 'MUN',
        'Newcastle': 'NEW',
        'Newcastle United': 'NEW',
        'Nottingham Forest': 'NOT',
        'Sheffield United': 'SHE',
        'Tottenham': 'TOT',
        'Tottenham Hotspur': 'TOT',
        'Tottenham Hotspur FC': 'TOT',
        'West Ham': 'WHU',
        'West Ham United': 'WHU',
        'Wolves': 'WOL',
        'Wolverhampton Wanderers': 'WOL'
    };
    
    return abbreviations[teamName] || teamName.substring(0, 3).toUpperCase();
}

document.addEventListener('DOMContentLoaded', function() {
    // Handle single player form submission
    document.getElementById('addPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('playerName').value.trim();
        const whatsapp = document.getElementById('playerWhatsapp').value.trim();
        
        if (!name) {
            alert('Please enter a player name');
            return;
        }
        
        fetch('/api/players', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                whatsapp_number: whatsapp
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error adding player: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error adding player: ' + error);
        });
    });
    
    // Handle bulk player form submission
    document.getElementById('bulkPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const bulkData = document.getElementById('bulkPlayerData').value.trim();
        
        if (!bulkData) {
            alert('Please enter player data');
            return;
        }
        
        const players = [];
        const lines = bulkData.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const parts = line.split(',');
            let name, whatsapp = null;
            
            if (parts.length === 1) {
                // Name only
                name = parts[0].trim();
            } else if (parts.length === 2) {
                // Name and WhatsApp number
                name = parts[0].trim();
                whatsapp = parts[1].trim();
            } else {
                alert(`Invalid format on line ${i + 1}. Use: Name or Name, WhatsApp Number`);
                return;
            }
            
            if (!name) {
                alert(`Missing name on line ${i + 1}`);
                return;
            }
            
            const playerData = {
                name: name,
                whatsapp_number: whatsapp || '' // Empty string if no number provided
            };
            
            players.push(playerData);
        }
        
        if (players.length === 0) {
            alert('No valid players found');
            return;
        }
        
        fetch('/api/players/bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                players: players
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully imported ${data.count} players`);
                location.reload();
            } else {
                alert('Error importing players: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error importing players: ' + error);
        });
    });
    
    // Handle edit player buttons
    document.querySelectorAll('.edit-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            const playerWhatsapp = this.getAttribute('data-player-whatsapp');
            
            document.getElementById('editPlayerId').value = playerId;
            document.getElementById('editPlayerName').value = playerName;
            document.getElementById('editPlayerWhatsapp').value = playerWhatsapp || '';
            
            new bootstrap.Modal(document.getElementById('editPlayerModal')).show();
        });
    });
    
    // Handle edit player form submission
    document.getElementById('editPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const playerId = document.getElementById('editPlayerId').value;
        const name = document.getElementById('editPlayerName').value.trim();
        const whatsapp = document.getElementById('editPlayerWhatsapp').value.trim();
        
        if (!name) {
            alert('Player name is required');
            return;
        }
        
        fetch(`/api/players/${playerId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                whatsapp_number: whatsapp
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating player: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating player: ' + error);
        });
    });
    
    // Handle delete player buttons
    document.querySelectorAll('.delete-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            
            document.getElementById('deletePlayerId').value = playerId;
            document.getElementById('deletePlayerName').textContent = playerName;
            
            new bootstrap.Modal(document.getElementById('deletePlayerModal')).show();
        });
    });

    // Handle registration link buttons
    document.querySelectorAll('.registration-link-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            
            document.getElementById('linkPlayerId').value = playerId;
            document.getElementById('linkPlayerName').textContent = playerName;
            
            // Generate registration link
            try {
                const response = await fetch('/api/registration-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player_id: parseInt(playerId)
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('registrationUrl').value = data.registration_url;
                    new bootstrap.Modal(document.getElementById('registrationLinkModal')).show();
                } else {
                    alert('Error generating registration link: ' + data.error);
                }
                
            } catch (error) {
                alert('Error generating registration link: ' + error.message);
            }
        });
    });

    // Handle general registration link button
    document.getElementById('generateGeneralLinkBtn').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/general-registration-link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                document.getElementById('generalRegistrationUrl').value = data.registration_url;
                new bootstrap.Modal(document.getElementById('generalRegistrationLinkModal')).show();
            } else {
                alert('Error generating general registration link: ' + data.error);
            }
            
        } catch (error) {
            alert('Error generating general registration link: ' + error.message);
        }
    });

    // Handle copy general registration link button
    document.getElementById('copyGeneralLinkBtn').addEventListener('click', async function() {
        const registrationUrl = document.getElementById('generalRegistrationUrl').value;
        const copySuccess = document.getElementById('copyGeneralSuccess');
        
        try {
            await navigator.clipboard.writeText(registrationUrl);
            copySuccess.classList.remove('d-none');
            setTimeout(() => {
                copySuccess.classList.add('d-none');
            }, 3000);
        } catch (err) {
            // Fallback for browsers that don't support clipboard API
            const textArea = document.createElement('textarea');
            textArea.value = registrationUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            copySuccess.classList.remove('d-none');
            setTimeout(() => {
                copySuccess.classList.add('d-none');
            }, 3000);
        }
    });

    // Handle copy registration link button
    document.getElementById('copyLinkBtn').addEventListener('click', async function() {
        const registrationUrl = document.getElementById('registrationUrl').value;
        const copySuccess = document.getElementById('copySuccess');
        
        try {
            await navigator.clipboard.writeText(registrationUrl);
            copySuccess.classList.remove('d-none');
            setTimeout(() => {
                copySuccess.classList.add('d-none');
            }, 3000);
        } catch (err) {
            // Fallback for browsers that don't support clipboard API
            const textArea = document.createElement('textarea');
            textArea.value = registrationUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            copySuccess.classList.remove('d-none');
            setTimeout(() => {
                copySuccess.classList.add('d-none');
            }, 3000);
        }
    });
    
    // Handle delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        const playerId = document.getElementById('deletePlayerId').value;
        
        fetch(`/api/players/${playerId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting player: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting player: ' + error);
        });
    });
    
    // Handle eliminate player buttons
    document.querySelectorAll('.eliminate-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            
            if (!confirm(`Are you sure you want to eliminate ${playerName}? This will mark them as eliminated from the competition.`)) {
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Eliminating...';
            
            fetch(`/api/players/${playerId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'eliminated' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error eliminating player: ' + data.error);
                    this.disabled = false;
                    this.textContent = 'Eliminate';
                }
            })
            .catch(error => {
                alert('Error eliminating player: ' + error);
                this.disabled = false;
                this.textContent = 'Eliminate';
            });
        });
    });
    
    // Handle reactivate player buttons
    document.querySelectorAll('.reactivate-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            
            if (!confirm(`Are you sure you want to reactivate ${playerName}? This will bring them back into the competition.`)) {
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Reactivating...';
            
            fetch(`/api/players/${playerId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'active' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error reactivating player: ' + data.error);
                    this.disabled = false;
                    this.textContent = 'Reactivate';
                }
            })
            .catch(error => {
                alert('Error reactivating player: ' + error);
                this.disabled = false;
                this.textContent = 'Reactivate';
            });
        });
    });
    
    // Handle password change form
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            alert('New password and confirmation do not match');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('New password must be at least 6 characters');
            return;
        }
        
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Changing...';
        
        fetch('/admin/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                document.getElementById('changePasswordModal').querySelector('[data-bs-dismiss="modal"]').click();
                // Clear form
                this.reset();
            } else {
                alert('Error changing password: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error changing password: ' + error);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Change Password';
        });
    });
    
    // Reset password form when modal is hidden
    document.getElementById('changePasswordModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('changePasswordForm').reset();
    });
    
    // Auto-populate next round number and load matchdays when modal opens
    document.getElementById('createRoundModal').addEventListener('show.bs.modal', function() {
        // Populate next round number
        fetch('/api/rounds')
            .then(response => response.json())
            .then(data => {
                let maxRound = 0;
                data.forEach(round => {
                    if (round.round_number > maxRound) {
                        maxRound = round.round_number;
                    }
                });
                document.getElementById('roundNumber').value = maxRound + 1;
            })
            .catch(error => {
                console.error('Error fetching rounds:', error);
                document.getElementById('roundNumber').value = 1;
            });
        
        // Load available matchdays
        const matchdaySelect = document.getElementById('plMatchday');
        matchdaySelect.innerHTML = '<option value="">Loading matchdays...</option>';
        
        fetch('/api/matchdays')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    matchdaySelect.innerHTML = '<option value="">Select a matchday...</option>';
                    data.matchdays.forEach(matchday => {
                        const option = document.createElement('option');
                        option.value = matchday.matchday;
                        option.textContent = `Matchday ${matchday.matchday} (${matchday.fixture_count} fixtures)`;
                        matchdaySelect.appendChild(option);
                    });
                } else {
                    matchdaySelect.innerHTML = '<option value="">Error loading matchdays</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching matchdays:', error);
                matchdaySelect.innerHTML = '<option value="">Error loading matchdays</option>';
            });
    });
    
    // Handle matchday selection change
    document.getElementById('plMatchday').addEventListener('change', function() {
        const matchday = this.value;
        const infoDiv = document.getElementById('matchdayInfo');
        
        if (!matchday) {
            infoDiv.innerHTML = '';
            return;
        }
        
        infoDiv.innerHTML = 'Loading matchday info...';
        
        fetch(`/api/matchdays/${matchday}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Matchday info response:', data);
                if (data.success && data.info) {
                    const info = data.info;
                    let infoText = `${info.fixture_count} fixtures`;
                    if (info.earliest_date && info.latest_date) {
                        const startDate = new Date(info.earliest_date).toLocaleDateString();
                        const endDate = new Date(info.latest_date).toLocaleDateString();
                        if (startDate === endDate) {
                            infoText += ` on ${startDate}`;
                        } else {
                            infoText += ` from ${startDate} to ${endDate}`;
                        }
                    }
                    // Add source info for debugging
                    if (data.source === 'fallback') {
                        infoText += ' (estimated)';
                    }
                    infoDiv.innerHTML = infoText;
                } else {
                    console.error('Matchday info error:', data.error || 'Unknown error');
                    infoDiv.innerHTML = `Could not load matchday info${data.error ? ': ' + data.error : ''}`;
                }
            })
            .catch(error => {
                console.error('Error fetching matchday info:', error);
                infoDiv.innerHTML = `Error loading matchday info: ${error.message}`;
            });
    });
    
    // Handle create round form submission
    document.getElementById('createRoundForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const roundNumber = document.getElementById('roundNumber').value;
        const plMatchday = document.getElementById('plMatchday').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const status = document.getElementById('roundStatus').value;
        
        if (!roundNumber) {
            alert('Round number is required');
            return;
        }
        
        if (!plMatchday) {
            alert('Premier League matchday is required');
            return;
        }
        
        // Validate dates if both are provided
        if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
            alert('End date must be after start date');
            return;
        }
        
        const roundData = {
            round_number: parseInt(roundNumber),
            pl_matchday: parseInt(plMatchday),
            status: status
        };
        
        if (startDate) {
            roundData.start_date = startDate;
        }
        
        if (endDate) {
            roundData.end_date = endDate;
        }
        
        fetch('/api/rounds', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(roundData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Round ${data.round_number} created successfully!`;
                if (data.fixtures_added > 0) {
                    message += ` ${data.fixtures_added} Premier League fixtures added.`;
                }
                if (data.warning) {
                    message += `\n\nWarning: ${data.warning}`;
                }
                alert(message);
                location.reload();
            } else {
                alert('Error creating round: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error creating round: ' + error);
        });
    });
    
    // Handle reset game confirmation input
    document.getElementById('confirmResetText').addEventListener('input', function() {
        const confirmBtn = document.getElementById('confirmResetBtn');
        const inputValue = this.value.trim();
        
        if (inputValue === 'RESET GAME') {
            confirmBtn.disabled = false;
        } else {
            confirmBtn.disabled = true;
        }
    });
    
    // Handle reset game confirmation
    document.getElementById('confirmResetBtn').addEventListener('click', function() {
        const confirmText = document.getElementById('confirmResetText').value.trim();
        
        if (confirmText !== 'RESET GAME') {
            alert('Please type "RESET GAME" to confirm');
            return;
        }
        
        if (!confirm('Are you absolutely sure you want to reset the game? This cannot be undone.')) {
            return;
        }
        
        fetch('/api/reset-game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Game reset successfully!\n\nDeleted:\n- ${data.rounds_deleted} rounds\n- ${data.fixtures_deleted} fixtures\n- ${data.picks_deleted} picks\n- ${data.pick_tokens_deleted} pick tokens\n\nPlayers preserved: ${data.players_reset}`);
                location.reload();
            } else {
                alert('Error resetting game: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error resetting game: ' + error);
        });
    });
    
    // Reset confirmation text when modal is hidden
    document.getElementById('resetGameModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('confirmResetText').value = '';
        document.getElementById('confirmResetBtn').disabled = true;
    });
    
    // Load rounds when Process Results modal opens
    document.getElementById('resultsModal').addEventListener('show.bs.modal', function() {
        const roundSelect = document.getElementById('resultsRoundSelect');
        roundSelect.innerHTML = '<option value="">Loading rounds...</option>';
        document.getElementById('processResultsBtn').disabled = true;
        
        fetch('/api/rounds')
            .then(response => response.json())
            .then(data => {
                roundSelect.innerHTML = '<option value="">Select a round...</option>';
                data.forEach(round => {
                    const option = document.createElement('option');
                    option.value = round.id;
                    option.textContent = `Round ${round.round_number} (${round.status})`;
                    roundSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading rounds:', error);
                roundSelect.innerHTML = '<option value="">Error loading rounds</option>';
            });
    });
    
    // Handle round selection for results
    document.getElementById('resultsRoundSelect').addEventListener('change', function() {
        const roundId = this.value;
        const processBtn = document.getElementById('processResultsBtn');
        const roundInfo = document.getElementById('resultsRoundInfo');
        const fixturesDiv = document.getElementById('roundFixtures');
        const picksDiv = document.getElementById('playerPicks');
        
        if (!roundId) {
            processBtn.disabled = true;
            roundInfo.innerHTML = '';
            fixturesDiv.innerHTML = '';
            picksDiv.innerHTML = '';
            return;
        }
        
        roundInfo.innerHTML = 'Loading round data...';
        
        fetch(`/api/rounds/${roundId}/picks`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const round = data.round;
                    const fixtures = data.fixtures;
                    const picks = data.picks;
                    
                    // Display round info
                    roundInfo.innerHTML = `
                        <div class="alert alert-info">
                            <strong>Round ${round.round_number}</strong> - Status: <span class="badge bg-${round.status === 'active' ? 'success' : 'secondary'}">${round.status}</span><br>
                            Fixtures: ${fixtures.length} | Player Picks: ${picks.length}
                        </div>
                    `;
                    
                    // Display fixtures with score inputs
                    if (fixtures.length > 0) {
                        let fixturesHtml = `
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Match Results</h6>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="autoPopulateBtn">
                                    <i class="fas fa-download me-1"></i>Auto-Populate from API
                                </button>
                            </div>
                            <div class="row">
                        `;
                        
                        fixtures.forEach(fixture => {
                            const homeAbbrev = getTeamAbbreviation(fixture.home_team);
                            const awayAbbrev = getTeamAbbreviation(fixture.away_team);
                            
                            fixturesHtml += `
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 title="${fixture.home_team} vs ${fixture.away_team}">${homeAbbrev} vs ${awayAbbrev}</h6>
                                            <div class="row">
                                                <div class="col-5">
                                                    <label class="form-label small" title="${fixture.home_team}">${homeAbbrev}</label>
                                                    <input type="number" class="form-control score-input" 
                                                           data-fixture-id="${fixture.id}" 
                                                           data-type="home"
                                                           value="${fixture.home_score !== null ? fixture.home_score : ''}" 
                                                           min="0" placeholder="-">
                                                </div>
                                                <div class="col-2 text-center pt-4">
                                                    <strong>-</strong>
                                                </div>
                                                <div class="col-5">
                                                    <label class="form-label small" title="${fixture.away_team}">${awayAbbrev}</label>
                                                    <input type="number" class="form-control score-input" 
                                                           data-fixture-id="${fixture.id}" 
                                                           data-type="away"
                                                           value="${fixture.away_score !== null ? fixture.away_score : ''}" 
                                                           min="0" placeholder="-">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        fixturesHtml += '</div>';
                        fixturesDiv.innerHTML = fixturesHtml;
                    }
                    
                    // Display player picks
                    if (picks.length > 0) {
                        // Sort picks by team picked
                        picks.sort((a, b) => a.team_picked.localeCompare(b.team_picked));
                        
                        let picksHtml = '<h6 class="mt-4">Player Picks</h6><div class="table-responsive"><table class="table table-sm"><thead><tr><th>Player</th><th>Team Picked</th><th>Current Status</th></tr></thead><tbody>';
                        
                        picks.forEach(pick => {
                            let statusBadge = 'secondary';
                            let statusText = 'Pending';
                            
                            if (pick.is_winner === true) {
                                statusBadge = 'success';
                                statusText = 'Winner';
                            } else if (pick.is_winner === false) {
                                statusBadge = 'danger';
                                statusText = 'Eliminated';
                            }
                            
                            const teamAbbrev = getTeamAbbreviation(pick.team_picked);
                            
                            picksHtml += `
                                <tr>
                                    <td><strong>${pick.player_name}</strong></td>
                                    <td><span title="${pick.team_picked}">${teamAbbrev}</span></td>
                                    <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                                </tr>
                            `;
                        });
                        
                        picksHtml += '</tbody></table></div>';
                        picksDiv.innerHTML = picksHtml;
                    } else {
                        picksDiv.innerHTML = '<div class="alert alert-warning">No picks found for this round</div>';
                    }
                    
                    processBtn.disabled = picks.length === 0;
                    
                    // Add event listener to auto-populate button (after it's created)
                    const autoPopulateBtn = document.getElementById('autoPopulateBtn');
                    if (autoPopulateBtn) {
                        autoPopulateBtn.addEventListener('click', function() {
                            this.disabled = true;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
                            
                            fetch(`/api/rounds/${roundId}/auto-populate-results`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert(`${data.message}\n\nUpdated ${data.updated_fixtures} fixtures with completed results.`);
                                    // Reload the round data to show updated scores
                                    document.getElementById('resultsRoundSelect').dispatchEvent(new Event('change'));
                                } else {
                                    alert('Error auto-populating results: ' + data.error);
                                }
                            })
                            .catch(error => {
                                alert('Error auto-populating results: ' + error);
                            })
                            .finally(() => {
                                this.disabled = false;
                                this.innerHTML = '<i class="fas fa-download me-1"></i>Auto-Populate from API';
                            });
                        });
                    }
                } else {
                    roundInfo.innerHTML = '<div class="alert alert-danger">Error loading round data</div>';
                    processBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading round data:', error);
                roundInfo.innerHTML = '<div class="alert alert-danger">Error loading data</div>';
                processBtn.disabled = true;
            });
    });
    
    // Handle process results
    document.getElementById('processResultsBtn').addEventListener('click', function() {
        const roundId = document.getElementById('resultsRoundSelect').value;
        
        if (!roundId) {
            alert('Please select a round');
            return;
        }
        
        // Collect all scores
        const scoreInputs = document.querySelectorAll('.score-input');
        const results = [];
        const fixtureResults = {};
        
        scoreInputs.forEach(input => {
            const fixtureId = input.getAttribute('data-fixture-id');
            const type = input.getAttribute('data-type');
            const score = input.value.trim();
            
            // Only include if score is explicitly entered (not empty)
            if (score !== '' && !isNaN(parseInt(score))) {
                if (!fixtureResults[fixtureId]) {
                    fixtureResults[fixtureId] = { fixture_id: parseInt(fixtureId) };
                }
                fixtureResults[fixtureId][type + '_score'] = parseInt(score);
            }
        });
        
        // Convert to array and validate - only include fixtures with BOTH scores entered
        for (const fixtureId in fixtureResults) {
            const result = fixtureResults[fixtureId];
            if ('home_score' in result && 'away_score' in result) {
                results.push(result);
            }
        }
        
        if (results.length === 0) {
            alert('Please enter scores for at least one match');
            return;
        }
        
        if (!confirm(`Are you sure you want to process results for ${results.length} matches? This will eliminate players whose teams lost or drew.`)) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'Processing...';
        
        fetch(`/api/rounds/${roundId}/process-results`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ results: results })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Results processed successfully!\n\nEliminated players: ${data.total_eliminated}\nSurviving players: ${data.total_surviving}`);
                document.getElementById('resultsModal').querySelector('[data-bs-dismiss="modal"]').click();
                location.reload();
            } else {
                alert('Error processing results: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error processing results: ' + error);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'Process Results & Eliminate Players';
        });
    });
    
    // Reset results modal when hidden
    document.getElementById('resultsModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('resultsRoundSelect').value = '';
        document.getElementById('resultsRoundInfo').innerHTML = '';
        document.getElementById('roundFixtures').innerHTML = '';
        document.getElementById('playerPicks').innerHTML = '';
        document.getElementById('processResultsBtn').disabled = true;
    });
    
    // Re-attach event listeners after sorting
    function attachPlayerEventListeners() {
        // Implementation here...
    }
    
    // Load rounds when manage rounds modal opens
    document.getElementById('manageRoundsModal').addEventListener('show.bs.modal', function() {
        const roundsList = document.getElementById('roundsList');
        roundsList.innerHTML = 'Loading rounds...';
        
        fetch('/api/rounds')
            .then(response => response.json())
            .then(data => {
                let html = '';
                if (data.length === 0) {
                    html = '<p class="text-muted">No rounds found</p>';
                } else {
                    html = '<div class="list-group">';
                    data.forEach(round => {
                        const statusBadge = round.status === 'active' ? 'bg-success' : 
                                          round.status === 'pending' ? 'bg-warning' : 'bg-secondary';
                        
                        html += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Round ${round.round_number}</h6>
                                    <small class="text-muted">PL Matchday ${round.pl_matchday || 'N/A'}</small>
                                    <span class="badge ${statusBadge} ms-2">${round.status}</span>
                                </div>
                                <div class="btn-group" role="group">
                                    ${round.status !== 'active' ? `
                                        <button class="btn btn-sm btn-outline-success activate-round-btn" data-round-id="${round.id}" data-round-number="${round.round_number}">
                                            <i class="fas fa-play"></i> Activate
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-outline-danger delete-round-btn" data-round-id="${round.id}" data-round-number="${round.round_number}">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                roundsList.innerHTML = html;
                
                // Attach event listeners for activate and delete buttons
                attachRoundManagementListeners();
            })
            .catch(error => {
                roundsList.innerHTML = '<p class="text-danger">Error loading rounds: ' + error + '</p>';
            });
    });
    
    function attachRoundManagementListeners() {
        // Activate round buttons
        document.querySelectorAll('.activate-round-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const roundId = this.dataset.roundId;
                const roundNumber = this.dataset.roundNumber;
                
                if (confirm(`Activate Round ${roundNumber}? This will deactivate any other active rounds.`)) {
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activating...';
                    
                    fetch(`/api/rounds/${roundId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({status: 'active'})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`Round ${roundNumber} activated successfully!`);
                            // Reload the modal content
                            document.getElementById('manageRoundsModal').dispatchEvent(new Event('show.bs.modal'));
                        } else {
                            alert('Error activating round: ' + data.error);
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-play"></i> Activate';
                        }
                    })
                    .catch(error => {
                        alert('Error activating round: ' + error);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-play"></i> Activate';
                    });
                }
            });
        });
        
        // Delete round buttons
        document.querySelectorAll('.delete-round-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const roundId = this.dataset.roundId;
                const roundNumber = this.dataset.roundNumber;
                
                if (confirm(`Delete Round ${roundNumber}? This will permanently delete the round and all its fixtures. This cannot be undone.`)) {
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    
                    fetch(`/api/rounds/${roundId}`, {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`Round ${roundNumber} deleted successfully!`);
                            // Reload the modal content
                            document.getElementById('manageRoundsModal').dispatchEvent(new Event('show.bs.modal'));
                        } else {
                            alert('Error deleting round: ' + data.error);
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-trash"></i> Delete';
                        }
                    })
                    .catch(error => {
                        alert('Error deleting round: ' + error);
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-trash"></i> Delete';
                    });
                }
            });
        });
    }
});

// Player sorting functionality
let currentNameSort = 'none'; // 'none', 'asc', 'desc'

function sortPlayersByName() {
    const playersTable = document.querySelector('.table tbody');
    const rows = Array.from(playersTable.querySelectorAll('tr'));
    const sortIcon = document.getElementById('nameSortIcon');
    
    // Determine next sort direction
    if (currentNameSort === 'none' || currentNameSort === 'desc') {
        currentNameSort = 'asc';
        sortIcon.textContent = '↑';
    } else {
        currentNameSort = 'desc';
        sortIcon.textContent = '↓';
    }
    
    // Sort rows by name (2nd column for desktop, 1st for mobile)
    rows.sort((a, b) => {
        const nameA = a.cells[1].querySelector('strong').textContent.trim().toLowerCase();
        const nameB = b.cells[1].querySelector('strong').textContent.trim().toLowerCase();
        
        if (currentNameSort === 'asc') {
            return nameA.localeCompare(nameB);
        } else {
            return nameB.localeCompare(nameA);
        }
    });
    
    // Clear and re-append sorted rows
    playersTable.innerHTML = '';
    rows.forEach(row => playersTable.appendChild(row));
    
    // Re-attach event listeners to the sorted rows
    attachPlayerEventListeners();
}

function attachPlayerEventListeners() {
    // Re-attach all player-related event listeners
    // (Implementation would go here to reattach events after sorting)
}
</script>
{% endblock %}