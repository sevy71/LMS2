{% extends "base.html" %}

{% block title %}Admin Dashboard - Last Man Standing{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h1 class="mb-4">Admin Dashboard</h1>
        <div>
            <button class="btn btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                <i class="fas fa-key"></i> Change Password
            </button>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Current Round</h5>
            </div>
            <div class="card-body">
                {% if current_round %}
                    <h6 class="card-subtitle mb-2 text-muted">Round {{ current_round.round_number }}</h6>
                    <p class="card-text">
                        <strong>Status:</strong> 
                        <span class="badge {% if current_round.status == 'active' %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ current_round.status.title() }}
                        </span>
                    </p>
                    {% if current_round.start_date %}
                        <p class="card-text"><strong>Start:</strong> {{ current_round.start_date.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}
                    {% if current_round.end_date %}
                        <p class="card-text"><strong>End:</strong> {{ current_round.end_date.strftime('%Y-%m-%d %H:%M') }}</p>
                    {% endif %}
                {% else %}
                    <p class="card-text text-muted">No active round</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Competition Stats</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    <strong>Total Players:</strong> {{ players|length }}
                </p>
                <p class="card-text">
                    <strong>Active Players:</strong> {{ players|selectattr('status', 'equalto', 'active')|list|length }}
                </p>
                <p class="card-text">
                    <strong>Eliminated:</strong> {{ players|selectattr('status', 'equalto', 'eliminated')|list|length }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Players</h5>
                <div class="dropdown">
                    <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Add Player
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addPlayerModal">Add Single Player</a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkPlayerModal">Bulk Import Players</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                {% if players %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>WhatsApp Number</th>
                                    <th>Status</th>
                                    <th>Unreachable</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in players %}
                                    <tr>
                                        <td>{{ player.id }}</td>
                                        <td>{{ player.name }}</td>
                                        <td>{{ player.whatsapp_number }}</td>
                                        <td>
                                            <span class="badge 
                                                {% if player.status == 'active' %}bg-success
                                                {% elif player.status == 'eliminated' %}bg-danger
                                                {% else %}bg-warning{% endif %}">
                                                {{ player.status.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if player.unreachable %}
                                                <span class="badge bg-warning">Yes</span>
                                            {% else %}
                                                <span class="badge bg-success">No</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary edit-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}" data-player-whatsapp="{{ player.whatsapp_number }}">Edit</button>
                                            {% if player.status == 'active' %}
                                                <button class="btn btn-sm btn-outline-warning eliminate-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">Eliminate</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-success reactivate-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">Reactivate</button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-danger delete-player-btn" data-player-id="{{ player.id }}" data-player-name="{{ player.name }}">Delete</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No players registered yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#createRoundModal">Create New Round</button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addFixturesModal">Add Fixtures</button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('send_picks') }}" class="btn btn-warning w-100">Send Pick Links</a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#resultsModal">Process Results</button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#statsModal">📊 Player Statistics</button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#exportModal">💾 Export/Backup</button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#resetGameModal">Reset Game</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Single Player Modal -->
<div class="modal fade" id="addPlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Single Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addPlayerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="playerName" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="playerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="playerWhatsapp" class="form-label">WhatsApp Number</label>
                        <input type="tel" class="form-control" id="playerWhatsapp" placeholder="+44XXXXXXXXXX" required>
                        <div class="form-text">Include country code (e.g., +44 for UK)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Import Players Modal -->
<div class="modal fade" id="bulkPlayerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Import Players</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bulkPlayerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="bulkPlayerData" class="form-label">Player Data</label>
                        <textarea class="form-control" id="bulkPlayerData" rows="10" placeholder="John Smith&#10;Jane Doe, +447987654321&#10;Mike Johnson&#10;Sarah Wilson, +447555123456" required></textarea>
                        <div class="form-text">
                            Enter one player per line. Format options:<br>
                            • Name only: <strong>John Smith</strong><br>
                            • Name with WhatsApp: <strong>Jane Doe, +447987654321</strong>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Flexible Format:</strong> You can enter just names, or names with WhatsApp numbers. If no number is provided, it can be added later.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import Players</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Player Modal -->
<div class="modal fade" id="editPlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Player</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editPlayerForm">
                <input type="hidden" id="editPlayerId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editPlayerName" class="form-label">Player Name</label>
                        <input type="text" class="form-control" id="editPlayerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPlayerWhatsapp" class="form-label">WhatsApp Number</label>
                        <input type="tel" class="form-control" id="editPlayerWhatsapp" placeholder="+44XXXXXXXXXX">
                        <div class="form-text">Include country code (e.g., +44 for UK) or leave empty</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Player</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePlayerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deletePlayerId">
                <p>Are you sure you want to delete player <strong id="deletePlayerName"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Player</button>
            </div>
        </div>
    </div>
</div>

<!-- Create New Round Modal -->
<div class="modal fade" id="createRoundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Round</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createRoundForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roundNumber" class="form-label">Game Round Number</label>
                        <input type="number" class="form-control" id="roundNumber" min="1" required>
                        <div class="form-text">Enter the game round number (e.g., 1, 2, 3...)</div>
                    </div>
                    <div class="mb-3">
                        <label for="plMatchday" class="form-label">Premier League Matchday</label>
                        <select class="form-control" id="plMatchday" required>
                            <option value="">Loading matchdays...</option>
                        </select>
                        <div class="form-text">Select which PL matchday to use for fixtures</div>
                        <div id="matchdayInfo" class="mt-2 text-muted"></div>
                    </div>
                    <div class="mb-3">
                        <label for="startDate" class="form-label">Start Date & Time</label>
                        <input type="datetime-local" class="form-control" id="startDate">
                        <div class="form-text">When players can start making picks (optional)</div>
                    </div>
                    <div class="mb-3">
                        <label for="endDate" class="form-label">End Date & Time</label>
                        <input type="datetime-local" class="form-control" id="endDate">
                        <div class="form-text">Deadline for picks (optional)</div>
                    </div>
                    <div class="mb-3">
                        <label for="roundStatus" class="form-label">Initial Status</label>
                        <select class="form-control" id="roundStatus" required>
                            <option value="pending">Pending</option>
                            <option value="active">Active</option>
                        </select>
                        <div class="form-text">Set to Active to allow picks immediately</div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Note:</strong> You can add fixtures to this round after creating it using the "Add Fixtures" button.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Round</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Game Modal -->
<div class="modal fade" id="resetGameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset Game</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>Warning:</strong> This will permanently delete all game data except players.
                </div>
                <p>This action will delete:</p>
                <ul>
                    <li>All rounds and fixtures</li>
                    <li>All player picks</li>
                    <li>All pending WhatsApp messages</li>
                </ul>
                <p><strong>Players will be preserved</strong> but their status will be reset to "active".</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
                
                <div class="mt-3">
                    <label for="confirmResetText" class="form-label">Type "RESET GAME" to confirm:</label>
                    <input type="text" class="form-control" id="confirmResetText" placeholder="RESET GAME">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmResetBtn" disabled>Reset Game</button>
            </div>
        </div>
    </div>
</div>

<!-- Send Pick Links Modal -->
<div class="modal fade" id="sendPickLinksModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Pick Links</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="roundSelect" class="form-label">Select Round</label>
                    <select class="form-control" id="roundSelect" required>
                        <option value="">Loading rounds...</option>
                    </select>
                    <div class="form-text">Pick links will be sent to all active players for this round</div>
                </div>
                
                <div id="roundInfo" class="mt-3"></div>
                
                <div class="alert alert-info">
                    <strong>What will happen:</strong><br>
                    • Unique secure links will be generated for each active player<br>
                    • Links will be queued for WhatsApp delivery<br>
                    • Players can use their link to submit their pick<br>
                    • Each link can only be used once and expires after 7 days
                </div>
                
                <div id="playersPreview" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmSendLinksBtn" disabled>Send Pick Links</button>
            </div>
        </div>
    </div>
</div>

<!-- Player Statistics Modal -->
<div class="modal fade" id="statsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">📊 Player Statistics Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-12">
                        <div id="competitionStats" class="row">
                            <!-- Competition stats will load here -->
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <h6>Individual Player Statistics</h6>
                        <div id="playerStatsTable">
                            Loading player statistics...
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h6>Pick History</h6>
                        <div id="pickHistoryTable">
                            Loading pick history...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Export/Backup Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">💾 Export & Backup Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Export Options:</strong> Download your competition data in various formats for backup or analysis.
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">👥 Players Data</h6>
                                <p class="card-text">Export all player information including status and contact details</p>
                                <button class="btn btn-primary export-btn" data-export="players">Download Players CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">🏆 Rounds & Fixtures</h6>
                                <p class="card-text">Export all rounds, fixtures, and match results</p>
                                <button class="btn btn-primary export-btn" data-export="rounds">Download Rounds CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">🎯 Player Picks</h6>
                                <p class="card-text">Export all player picks with results</p>
                                <button class="btn btn-primary export-btn" data-export="picks">Download Picks CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6 class="card-title">📊 Full Statistics</h6>
                                <p class="card-text">Export comprehensive player statistics</p>
                                <button class="btn btn-primary export-btn" data-export="stats">Download Stats CSV</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 mt-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="card-title">🔄 Complete Backup</h6>
                                <p class="card-text">Export everything in a single comprehensive file</p>
                                <button class="btn btn-success btn-lg export-btn" data-export="full">Download Complete Backup</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Admin Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                        <div class="form-text">Minimum 6 characters</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Process Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Process Match Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="resultsRoundSelect" class="form-label">Select Round</label>
                    <select class="form-control" id="resultsRoundSelect" required>
                        <option value="">Loading rounds...</option>
                    </select>
                    <div class="form-text">Select the round to process results for</div>
                </div>
                
                <div id="resultsRoundInfo" class="mt-3"></div>
                <div id="roundFixtures" class="mt-3"></div>
                <div id="playerPicks" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="processResultsBtn" disabled>Process Results & Eliminate Players</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Fixtures Modal -->
<div class="modal fade" id="addFixturesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Fixtures to Round</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="fixtureRoundSelect" class="form-label">Select Round</label>
                    <select class="form-control" id="fixtureRoundSelect" required>
                        <option value="">Loading rounds...</option>
                    </select>
                    <div class="form-text">Select a round that needs fixtures added</div>
                </div>
                
                <div id="fixtureRoundInfo" class="mt-3"></div>
                
                <div class="alert alert-info">
                    <strong>What will happen:</strong><br>
                    • Fixtures will be fetched from the Premier League API<br>
                    • If API fails, fallback fixtures will be created<br>
                    • This ensures players always have teams to pick from
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddFixturesBtn" disabled>Add Fixtures</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle single player form submission
    document.getElementById('addPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('playerName').value.trim();
        const whatsapp = document.getElementById('playerWhatsapp').value.trim();
        
        if (!name || !whatsapp) {
            alert('Please fill in all fields');
            return;
        }
        
        fetch('/api/players', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                whatsapp_number: whatsapp
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error adding player: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error adding player: ' + error);
        });
    });
    
    // Handle bulk player form submission
    document.getElementById('bulkPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const bulkData = document.getElementById('bulkPlayerData').value.trim();
        
        if (!bulkData) {
            alert('Please enter player data');
            return;
        }
        
        const players = [];
        const lines = bulkData.split('\n');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const parts = line.split(',');
            let name, whatsapp = null;
            
            if (parts.length === 1) {
                // Name only
                name = parts[0].trim();
            } else if (parts.length === 2) {
                // Name and WhatsApp number
                name = parts[0].trim();
                whatsapp = parts[1].trim();
            } else {
                alert(`Invalid format on line ${i + 1}. Use: Name or Name, WhatsApp Number`);
                return;
            }
            
            if (!name) {
                alert(`Missing name on line ${i + 1}`);
                return;
            }
            
            const playerData = {
                name: name,
                whatsapp_number: whatsapp || '' // Empty string if no number provided
            };
            
            players.push(playerData);
        }
        
        if (players.length === 0) {
            alert('No valid players found');
            return;
        }
        
        fetch('/api/players/bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                players: players
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully imported ${data.count} players`);
                location.reload();
            } else {
                alert('Error importing players: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error importing players: ' + error);
        });
    });
    
    // Handle edit player buttons
    document.querySelectorAll('.edit-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            const playerWhatsapp = this.getAttribute('data-player-whatsapp');
            
            document.getElementById('editPlayerId').value = playerId;
            document.getElementById('editPlayerName').value = playerName;
            document.getElementById('editPlayerWhatsapp').value = playerWhatsapp || '';
            
            new bootstrap.Modal(document.getElementById('editPlayerModal')).show();
        });
    });
    
    // Handle edit player form submission
    document.getElementById('editPlayerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const playerId = document.getElementById('editPlayerId').value;
        const name = document.getElementById('editPlayerName').value.trim();
        const whatsapp = document.getElementById('editPlayerWhatsapp').value.trim();
        
        if (!name) {
            alert('Player name is required');
            return;
        }
        
        fetch(`/api/players/${playerId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                whatsapp_number: whatsapp
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating player: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating player: ' + error);
        });
    });
    
    // Handle delete player buttons
    document.querySelectorAll('.delete-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            
            document.getElementById('deletePlayerId').value = playerId;
            document.getElementById('deletePlayerName').textContent = playerName;
            
            new bootstrap.Modal(document.getElementById('deletePlayerModal')).show();
        });
    });
    
    // Handle delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        const playerId = document.getElementById('deletePlayerId').value;
        
        fetch(`/api/players/${playerId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting player: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error deleting player: ' + error);
        });
    });
    
    // Handle eliminate player buttons
    document.querySelectorAll('.eliminate-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            
            if (!confirm(`Are you sure you want to eliminate ${playerName}? This will mark them as eliminated from the competition.`)) {
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Eliminating...';
            
            fetch(`/api/players/${playerId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'eliminated' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error eliminating player: ' + data.error);
                    this.disabled = false;
                    this.textContent = 'Eliminate';
                }
            })
            .catch(error => {
                alert('Error eliminating player: ' + error);
                this.disabled = false;
                this.textContent = 'Eliminate';
            });
        });
    });
    
    // Handle reactivate player buttons
    document.querySelectorAll('.reactivate-player-btn').forEach(button => {
        button.addEventListener('click', function() {
            const playerId = this.getAttribute('data-player-id');
            const playerName = this.getAttribute('data-player-name');
            
            if (!confirm(`Are you sure you want to reactivate ${playerName}? This will bring them back into the competition.`)) {
                return;
            }
            
            this.disabled = true;
            this.textContent = 'Reactivating...';
            
            fetch(`/api/players/${playerId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: 'active' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error reactivating player: ' + data.error);
                    this.disabled = false;
                    this.textContent = 'Reactivate';
                }
            })
            .catch(error => {
                alert('Error reactivating player: ' + error);
                this.disabled = false;
                this.textContent = 'Reactivate';
            });
        });
    });
    
    // Handle password change form
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            alert('New password and confirmation do not match');
            return;
        }
        
        if (newPassword.length < 6) {
            alert('New password must be at least 6 characters');
            return;
        }
        
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Changing...';
        
        fetch('/admin/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                document.getElementById('changePasswordModal').querySelector('[data-bs-dismiss="modal"]').click();
                // Clear form
                this.reset();
            } else {
                alert('Error changing password: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error changing password: ' + error);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Change Password';
        });
    });
    
    // Reset password form when modal is hidden
    document.getElementById('changePasswordModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('changePasswordForm').reset();
    });
    
    // Auto-populate next round number and load matchdays when modal opens
    document.getElementById('createRoundModal').addEventListener('show.bs.modal', function() {
        // Populate next round number
        fetch('/api/rounds')
            .then(response => response.json())
            .then(data => {
                let maxRound = 0;
                data.forEach(round => {
                    if (round.round_number > maxRound) {
                        maxRound = round.round_number;
                    }
                });
                document.getElementById('roundNumber').value = maxRound + 1;
            })
            .catch(error => {
                console.error('Error fetching rounds:', error);
                document.getElementById('roundNumber').value = 1;
            });
        
        // Load available matchdays
        const matchdaySelect = document.getElementById('plMatchday');
        matchdaySelect.innerHTML = '<option value="">Loading matchdays...</option>';
        
        fetch('/api/matchdays')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    matchdaySelect.innerHTML = '<option value="">Select a matchday...</option>';
                    data.matchdays.forEach(matchday => {
                        const option = document.createElement('option');
                        option.value = matchday.matchday;
                        option.textContent = `Matchday ${matchday.matchday} (${matchday.fixture_count} fixtures)`;
                        matchdaySelect.appendChild(option);
                    });
                } else {
                    matchdaySelect.innerHTML = '<option value="">Error loading matchdays</option>';
                }
            })
            .catch(error => {
                console.error('Error fetching matchdays:', error);
                matchdaySelect.innerHTML = '<option value="">Error loading matchdays</option>';
            });
    });
    
    // Handle matchday selection change
    document.getElementById('plMatchday').addEventListener('change', function() {
        const matchday = this.value;
        const infoDiv = document.getElementById('matchdayInfo');
        
        if (!matchday) {
            infoDiv.innerHTML = '';
            return;
        }
        
        infoDiv.innerHTML = 'Loading matchday info...';
        
        fetch(`/api/matchdays/${matchday}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Matchday info response:', data);
                if (data.success && data.info) {
                    const info = data.info;
                    let infoText = `${info.fixture_count} fixtures`;
                    if (info.earliest_date && info.latest_date) {
                        const startDate = new Date(info.earliest_date).toLocaleDateString();
                        const endDate = new Date(info.latest_date).toLocaleDateString();
                        if (startDate === endDate) {
                            infoText += ` on ${startDate}`;
                        } else {
                            infoText += ` from ${startDate} to ${endDate}`;
                        }
                    }
                    // Add source info for debugging
                    if (data.source === 'fallback') {
                        infoText += ' (estimated)';
                    }
                    infoDiv.innerHTML = infoText;
                } else {
                    console.error('Matchday info error:', data.error || 'Unknown error');
                    infoDiv.innerHTML = `Could not load matchday info${data.error ? ': ' + data.error : ''}`;
                }
            })
            .catch(error => {
                console.error('Error fetching matchday info:', error);
                infoDiv.innerHTML = `Error loading matchday info: ${error.message}`;
            });
    });
    
    // Handle create round form submission
    document.getElementById('createRoundForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const roundNumber = document.getElementById('roundNumber').value;
        const plMatchday = document.getElementById('plMatchday').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const status = document.getElementById('roundStatus').value;
        
        if (!roundNumber) {
            alert('Round number is required');
            return;
        }
        
        if (!plMatchday) {
            alert('Premier League matchday is required');
            return;
        }
        
        // Validate dates if both are provided
        if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
            alert('End date must be after start date');
            return;
        }
        
        const roundData = {
            round_number: parseInt(roundNumber),
            pl_matchday: parseInt(plMatchday),
            status: status
        };
        
        if (startDate) {
            roundData.start_date = startDate;
        }
        
        if (endDate) {
            roundData.end_date = endDate;
        }
        
        fetch('/api/rounds', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(roundData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Round ${data.round_number} created successfully!`;
                if (data.fixtures_added > 0) {
                    message += ` ${data.fixtures_added} Premier League fixtures added.`;
                }
                if (data.warning) {
                    message += `\n\nWarning: ${data.warning}`;
                }
                alert(message);
                location.reload();
            } else {
                alert('Error creating round: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error creating round: ' + error);
        });
    });
    
    // Handle reset game confirmation input
    document.getElementById('confirmResetText').addEventListener('input', function() {
        const confirmBtn = document.getElementById('confirmResetBtn');
        const inputValue = this.value.trim();
        
        if (inputValue === 'RESET GAME') {
            confirmBtn.disabled = false;
        } else {
            confirmBtn.disabled = true;
        }
    });
    
    // Handle reset game confirmation
    document.getElementById('confirmResetBtn').addEventListener('click', function() {
        const confirmText = document.getElementById('confirmResetText').value.trim();
        
        if (confirmText !== 'RESET GAME') {
            alert('Please type "RESET GAME" to confirm');
            return;
        }
        
        if (!confirm('Are you absolutely sure you want to reset the game? This cannot be undone.')) {
            return;
        }
        
        fetch('/api/reset-game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Game reset successfully!\n\nDeleted:\n- ${data.rounds_deleted} rounds\n- ${data.fixtures_deleted} fixtures\n- ${data.picks_deleted} picks\n- ${data.pick_tokens_deleted} pick tokens\n\nPlayers preserved: ${data.players_reset}`);
                location.reload();
            } else {
                alert('Error resetting game: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error resetting game: ' + error);
        });
    });
    
    // Reset confirmation text when modal is hidden
    document.getElementById('resetGameModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('confirmResetText').value = '';
        document.getElementById('confirmResetBtn').disabled = true;
    });
    
    // Load rounds when Send Pick Links modal opens
    document.getElementById('sendPickLinksModal').addEventListener('show.bs.modal', function() {
        const roundSelect = document.getElementById('roundSelect');
        roundSelect.innerHTML = '<option value="">Loading rounds...</option>';
        document.getElementById('confirmSendLinksBtn').disabled = true;
        
        fetch('/api/rounds')
            .then(response => response.json())
            .then(data => {
                roundSelect.innerHTML = '<option value="">Select a round...</option>';
                data.forEach(round => {
                    const option = document.createElement('option');
                    option.value = round.id;
                    option.textContent = `Round ${round.round_number} (${round.status})`;
                    roundSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading rounds:', error);
                roundSelect.innerHTML = '<option value="">Error loading rounds</option>';
            });
    });
    
    // Handle round selection change
    document.getElementById('roundSelect').addEventListener('change', function() {
        const roundId = this.value;
        const confirmBtn = document.getElementById('confirmSendLinksBtn');
        const roundInfo = document.getElementById('roundInfo');
        const playersPreview = document.getElementById('playersPreview');
        
        if (!roundId) {
            confirmBtn.disabled = true;
            roundInfo.innerHTML = '';
            playersPreview.innerHTML = '';
            return;
        }
        
        roundInfo.innerHTML = 'Loading round information...';
        playersPreview.innerHTML = '';
        
        // Get round info and active players
        Promise.all([
            fetch(`/api/rounds/${roundId}`),
            fetch('/api/players')
        ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(([roundData, playersData]) => {
            if (roundData.success && playersData) {
                const round = roundData.round;
                const activePlayers = playersData.filter(p => p.status === 'active');
                
                roundInfo.innerHTML = `
                    <div class="alert alert-secondary">
                        <strong>Round ${round.round_number}</strong> - Premier League Matchday ${round.pl_matchday}<br>
                        Status: <span class="badge bg-${round.status === 'active' ? 'success' : 'secondary'}">${round.status}</span><br>
                        Fixtures: ${round.fixture_count} matches
                    </div>
                `;
                
                if (activePlayers.length > 0) {
                    playersPreview.innerHTML = `
                        <div class="alert alert-success">
                            <strong>${activePlayers.length} active players</strong> will receive pick links:<br>
                            ${activePlayers.map(p => `<span class="badge bg-primary me-1">${p.name}</span>`).join('')}
                        </div>
                    `;
                    confirmBtn.disabled = false;
                } else {
                    playersPreview.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No active players found.</strong> Make sure there are active players before sending pick links.
                        </div>
                    `;
                    confirmBtn.disabled = true;
                }
            } else {
                roundInfo.innerHTML = '<div class="alert alert-danger">Error loading round information</div>';
                confirmBtn.disabled = true;
            }
        })
        .catch(error => {
            console.error('Error loading round/players info:', error);
            roundInfo.innerHTML = '<div class="alert alert-danger">Error loading information</div>';
            confirmBtn.disabled = true;
        });
    });
    
    // Handle send pick links confirmation
    document.getElementById('confirmSendLinksBtn').addEventListener('click', function() {
        const roundId = document.getElementById('roundSelect').value;
        
        if (!roundId) {
            alert('Please select a round');
            return;
        }
        
        if (!confirm('Are you sure you want to send pick links for this round? This will generate new secure links for all active players.')) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'Sending...';
        
        fetch('/api/send-pick-links', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                round_id: parseInt(roundId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Pick links sent successfully!\n\n• Generated ${data.tokens_created} pick tokens\n• Queued ${data.messages_queued} WhatsApp messages\n\nThe sender worker will process these messages automatically.`);
                document.getElementById('sendPickLinksModal').querySelector('[data-bs-dismiss="modal"]').click();
            } else {
                alert('Error sending pick links: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error sending pick links: ' + error);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'Send Pick Links';
        });
    });
    
    // Reset modal when hidden
    document.getElementById('sendPickLinksModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('roundSelect').value = '';
        document.getElementById('roundInfo').innerHTML = '';
        document.getElementById('playersPreview').innerHTML = '';
        document.getElementById('confirmSendLinksBtn').disabled = true;
    });
    
    // Load rounds when Add Fixtures modal opens
    document.getElementById('addFixturesModal').addEventListener('show.bs.modal', function() {
        const roundSelect = document.getElementById('fixtureRoundSelect');
        roundSelect.innerHTML = '<option value="">Loading rounds...</option>';
        document.getElementById('confirmAddFixturesBtn').disabled = true;
        
        fetch('/api/rounds')
            .then(response => response.json())
            .then(data => {
                roundSelect.innerHTML = '<option value="">Select a round...</option>';
                data.forEach(round => {
                    const option = document.createElement('option');
                    option.value = round.id;
                    option.textContent = `Round ${round.round_number} (${round.status})`;
                    roundSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading rounds:', error);
                roundSelect.innerHTML = '<option value="">Error loading rounds</option>';
            });
    });
    
    // Handle round selection for fixtures
    document.getElementById('fixtureRoundSelect').addEventListener('change', function() {
        const roundId = this.value;
        const confirmBtn = document.getElementById('confirmAddFixturesBtn');
        const roundInfo = document.getElementById('fixtureRoundInfo');
        
        if (!roundId) {
            confirmBtn.disabled = true;
            roundInfo.innerHTML = '';
            return;
        }
        
        roundInfo.innerHTML = 'Loading round information...';
        
        fetch(`/api/rounds/${roundId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const round = data.round;
                    roundInfo.innerHTML = `
                        <div class="alert alert-secondary">
                            <strong>Round ${round.round_number}</strong> - Premier League Matchday ${round.pl_matchday}<br>
                            Status: <span class="badge bg-${round.status === 'active' ? 'success' : 'secondary'}">${round.status}</span><br>
                            Current Fixtures: ${round.fixture_count}
                        </div>
                    `;
                    
                    if (round.fixture_count > 0) {
                        roundInfo.innerHTML += '<div class="alert alert-warning">This round already has fixtures. Adding fixtures will fail if fixtures already exist.</div>';
                    }
                    
                    confirmBtn.disabled = false;
                } else {
                    roundInfo.innerHTML = '<div class="alert alert-danger">Error loading round information</div>';
                    confirmBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading round info:', error);
                roundInfo.innerHTML = '<div class="alert alert-danger">Error loading information</div>';
                confirmBtn.disabled = true;
            });
    });
    
    // Handle add fixtures confirmation
    document.getElementById('confirmAddFixturesBtn').addEventListener('click', function() {
        const roundId = document.getElementById('fixtureRoundSelect').value;
        
        if (!roundId) {
            alert('Please select a round');
            return;
        }
        
        if (!confirm('Are you sure you want to add fixtures to this round?')) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'Adding Fixtures...';
        
        fetch(`/api/rounds/${roundId}/fixtures`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Fixtures added successfully!\n\n• Added ${data.fixtures_added} fixtures`;
                if (data.source === 'fallback') {
                    message += '\n• Used fallback fixtures (API unavailable)';
                }
                if (data.warning) {
                    message += `\n• Warning: ${data.warning}`;
                }
                alert(message);
                document.getElementById('addFixturesModal').querySelector('[data-bs-dismiss="modal"]').click();
                location.reload();
            } else {
                alert('Error adding fixtures: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error adding fixtures: ' + error);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'Add Fixtures';
        });
    });
    
    // Reset fixtures modal when hidden
    document.getElementById('addFixturesModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('fixtureRoundSelect').value = '';
        document.getElementById('fixtureRoundInfo').innerHTML = '';
        document.getElementById('confirmAddFixturesBtn').disabled = true;
    });
    
    // Load rounds when Process Results modal opens
    document.getElementById('resultsModal').addEventListener('show.bs.modal', function() {
        const roundSelect = document.getElementById('resultsRoundSelect');
        roundSelect.innerHTML = '<option value="">Loading rounds...</option>';
        document.getElementById('processResultsBtn').disabled = true;
        
        fetch('/api/rounds')
            .then(response => response.json())
            .then(data => {
                roundSelect.innerHTML = '<option value="">Select a round...</option>';
                data.forEach(round => {
                    const option = document.createElement('option');
                    option.value = round.id;
                    option.textContent = `Round ${round.round_number} (${round.status})`;
                    roundSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading rounds:', error);
                roundSelect.innerHTML = '<option value="">Error loading rounds</option>';
            });
    });
    
    // Handle round selection for results
    document.getElementById('resultsRoundSelect').addEventListener('change', function() {
        const roundId = this.value;
        const processBtn = document.getElementById('processResultsBtn');
        const roundInfo = document.getElementById('resultsRoundInfo');
        const fixturesDiv = document.getElementById('roundFixtures');
        const picksDiv = document.getElementById('playerPicks');
        
        if (!roundId) {
            processBtn.disabled = true;
            roundInfo.innerHTML = '';
            fixturesDiv.innerHTML = '';
            picksDiv.innerHTML = '';
            return;
        }
        
        roundInfo.innerHTML = 'Loading round data...';
        
        fetch(`/api/rounds/${roundId}/picks`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const round = data.round;
                    const fixtures = data.fixtures;
                    const picks = data.picks;
                    
                    // Display round info
                    roundInfo.innerHTML = `
                        <div class="alert alert-info">
                            <strong>Round ${round.round_number}</strong> - Status: <span class="badge bg-${round.status === 'active' ? 'success' : 'secondary'}">${round.status}</span><br>
                            Fixtures: ${fixtures.length} | Player Picks: ${picks.length}
                        </div>
                    `;
                    
                    // Display fixtures with score inputs
                    if (fixtures.length > 0) {
                        let fixturesHtml = `
                            <h6>Match Results</h6>
                            <div class="row">
                        `;
                        
                        fixtures.forEach(fixture => {
                            fixturesHtml += `
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>${fixture.home_team} vs ${fixture.away_team}</h6>
                                            <div class="row">
                                                <div class="col-5">
                                                    <label class="form-label">${fixture.home_team} Score</label>
                                                    <input type="number" class="form-control score-input" 
                                                           data-fixture-id="${fixture.id}" 
                                                           data-type="home"
                                                           value="${fixture.home_score || ''}" 
                                                           min="0" placeholder="0">
                                                </div>
                                                <div class="col-2 text-center pt-4">
                                                    <strong>-</strong>
                                                </div>
                                                <div class="col-5">
                                                    <label class="form-label">${fixture.away_team} Score</label>
                                                    <input type="number" class="form-control score-input" 
                                                           data-fixture-id="${fixture.id}" 
                                                           data-type="away"
                                                           value="${fixture.away_score || ''}" 
                                                           min="0" placeholder="0">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        fixturesHtml += '</div>';
                        fixturesDiv.innerHTML = fixturesHtml;
                    }
                    
                    // Display player picks
                    if (picks.length > 0) {
                        let picksHtml = '<h6 class="mt-4">Player Picks</h6><div class="table-responsive"><table class="table table-sm"><thead><tr><th>Player</th><th>Team Picked</th><th>Current Status</th></tr></thead><tbody>';
                        
                        picks.forEach(pick => {
                            let statusBadge = 'secondary';
                            let statusText = 'Pending';
                            
                            if (pick.is_winner === true) {
                                statusBadge = 'success';
                                statusText = 'Winner';
                            } else if (pick.is_winner === false) {
                                statusBadge = 'danger';
                                statusText = 'Eliminated';
                            }
                            
                            picksHtml += `
                                <tr>
                                    <td><strong>${pick.player_name}</strong></td>
                                    <td>${pick.team_picked}</td>
                                    <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                                </tr>
                            `;
                        });
                        
                        picksHtml += '</tbody></table></div>';
                        picksDiv.innerHTML = picksHtml;
                    } else {
                        picksDiv.innerHTML = '<div class="alert alert-warning">No picks found for this round</div>';
                    }
                    
                    processBtn.disabled = picks.length === 0;
                } else {
                    roundInfo.innerHTML = '<div class="alert alert-danger">Error loading round data</div>';
                    processBtn.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading round data:', error);
                roundInfo.innerHTML = '<div class="alert alert-danger">Error loading data</div>';
                processBtn.disabled = true;
            });
    });
    
    // Handle process results
    document.getElementById('processResultsBtn').addEventListener('click', function() {
        const roundId = document.getElementById('resultsRoundSelect').value;
        
        if (!roundId) {
            alert('Please select a round');
            return;
        }
        
        // Collect all scores
        const scoreInputs = document.querySelectorAll('.score-input');
        const results = [];
        const fixtureResults = {};
        
        scoreInputs.forEach(input => {
            const fixtureId = input.getAttribute('data-fixture-id');
            const type = input.getAttribute('data-type');
            const score = parseInt(input.value);
            
            if (!isNaN(score)) {
                if (!fixtureResults[fixtureId]) {
                    fixtureResults[fixtureId] = { fixture_id: parseInt(fixtureId) };
                }
                fixtureResults[fixtureId][type + '_score'] = score;
            }
        });
        
        // Convert to array and validate
        for (const fixtureId in fixtureResults) {
            const result = fixtureResults[fixtureId];
            if ('home_score' in result && 'away_score' in result) {
                results.push(result);
            }
        }
        
        if (results.length === 0) {
            alert('Please enter scores for at least one match');
            return;
        }
        
        if (!confirm(`Are you sure you want to process results for ${results.length} matches? This will eliminate players whose teams lost or drew.`)) {
            return;
        }
        
        this.disabled = true;
        this.textContent = 'Processing...';
        
        fetch(`/api/rounds/${roundId}/process-results`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ results: results })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Results processed successfully!\n\n`;
                message += `• Eliminated: ${data.total_eliminated} players\n`;
                message += `• Surviving: ${data.total_surviving} players\n\n`;
                
                if (data.eliminated_players.length > 0) {
                    message += `Eliminated players:\n${data.eliminated_players.join(', ')}`;
                }
                
                alert(message);
                document.getElementById('resultsModal').querySelector('[data-bs-dismiss="modal"]').click();
                location.reload();
            } else {
                alert('Error processing results: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error processing results: ' + error);
        })
        .finally(() => {
            this.disabled = false;
            this.textContent = 'Process Results & Eliminate Players';
        });
    });
    
    // Reset results modal when hidden
    document.getElementById('resultsModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('resultsRoundSelect').value = '';
        document.getElementById('resultsRoundInfo').innerHTML = '';
        document.getElementById('roundFixtures').innerHTML = '';
        document.getElementById('playerPicks').innerHTML = '';
        document.getElementById('processResultsBtn').disabled = true;
    });

    // --- Statistics Modal Logic ---
    document.getElementById('statsModal').addEventListener('show.bs.modal', function() {
        const competitionStatsDiv = document.getElementById('competitionStats');
        const playerStatsTableDiv = document.getElementById('playerStatsTable');
        const pickHistoryTableDiv = document.getElementById('pickHistoryTable');

        // Set loading state
        competitionStatsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        playerStatsTableDiv.innerHTML = '';
        pickHistoryTableDiv.innerHTML = '';

        fetch('/api/statistics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Render Competition Stats
                    const compStats = data.competition_stats;
                    competitionStatsDiv.innerHTML = `
                        <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${compStats.total_players}</h5><p class="card-text">Total Players</p></div></div></div>
                        <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${compStats.active_players}</h5><p class="card-text">Active</p></div></div></div>
                        <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${compStats.eliminated_players}</h5><p class="card-text">Eliminated</p></div></div></div>
                        <div class="col-md-3"><div class="card text-center"><div class="card-body"><h5>${compStats.elimination_rate}%</h5><p class="card-text">Elimination Rate</p></div></div></div>
                    `;

                    // Render Player Stats Table
                    let playerStatsHtml = '<div class="table-responsive"><table class="table table-striped table-sm"><thead><tr><th>Player</th><th>Status</th><th>Picks</th><th>Wins</th><th>Success</th><th>Streak</th><th>Teams Used</th></tr></thead><tbody>';
                    data.player_stats.forEach(player => {
                        playerStatsHtml += `
                            <tr>
                                <td>${player.name}</td>
                                <td><span class="badge bg-${player.status === 'active' ? 'success' : 'danger'}">${player.status}</span></td>
                                <td>${player.total_picks}</td>
                                <td>${player.winning_picks}</td>
                                <td>${player.success_rate}%</td>
                                <td>${player.current_streak}</td>
                                <td title="${player.teams_used.join(', ')}">${player.teams_used_count}</td>
                            </tr>
                        `;
                    });
                    playerStatsHtml += '</tbody></table></div>';
                    playerStatsTableDiv.innerHTML = playerStatsHtml;

                    // Render Pick History Table
                    let pickHistoryHtml = '<div class="table-responsive" style="max-height: 400px;"><table class="table table-striped table-sm"><thead><tr><th>Player</th><th>Round</th><th>Team Picked</th><th>Result</th><th>Date</th></tr></thead><tbody>';
                    data.pick_history.forEach(pick => {
                        let badgeClass = 'secondary';
                        if (pick.result === 'Winner') badgeClass = 'success';
                        if (pick.result === 'Eliminated') badgeClass = 'danger';
                        pickHistoryHtml += `
                            <tr>
                                <td>${pick.player_name}</td>
                                <td>${pick.round_number}</td>
                                <td>${pick.team_picked}</td>
                                <td><span class="badge bg-${badgeClass}">${pick.result}</span></td>
                                <td>${pick.pick_date}</td>
                            </tr>
                        `;
                    });
                    pickHistoryHtml += '</tbody></table></div>';
                    pickHistoryTableDiv.innerHTML = pickHistoryHtml;

                } else {
                    competitionStatsDiv.innerHTML = `<div class="alert alert-danger">Error loading statistics: ${data.error}</div>`;
                }
            })
            .catch(error => {
                console.error('Error fetching statistics:', error);
                competitionStatsDiv.innerHTML = '<div class="alert alert-danger">Error loading statistics.</div>';
            });
    });

    // --- Export/Backup Modal Logic ---
    document.querySelectorAll('.export-btn').forEach(button => {
        button.addEventListener('click', function() {
            const exportType = this.getAttribute('data-export');
            const url = `/api/export/${exportType}`;
            
            // Trigger download
            window.location.href = url;
        });
    });
});
</script>
{% endblock %}